<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZenMind — AI Success Architecture Mirror</title>
<style>
  :root { --bg:#0b1220; --card:#121a2a; --ink:#e8eefc; --muted:#9fb3d9; --accent:#6ea8fe; --line:#25324a; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--ink)}
  .wrap{max-width:980px;margin:32px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{font-size:28px;margin:0}
  .badge{font-size:12px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:260px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#101729;color:var(--ink)}
  textarea{min-height:88px}
  button{appearance:none;border:1px solid var(--line);background:#13203a;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
  button:hover{background:#162647}
  .btn-accent{background:var(--accent);border-color:#4a7fd9;color:#071023}
  .btn-ghost{background:transparent}
  .stack{display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  pre{white-space:pre-wrap;background:#0e1526;border:1px solid var(--line);padding:12px;border-radius:10px}
  hr{border:none;border-top:1px solid var(--line);margin:16px 0}
  .pill{font-size:12px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
  .foot{font-size:12px;color:var(--muted)}
  .success{border-color:#2c7a4b}
  .warn{border-color:#b08900}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>ZenMind</h1>
      <div class="badge">AI Success Architecture Mirror</div>
    </div>
    <div class="stack">
      <span class="pill" id="mode-pill">Mode: Local (OpenRouter)</span>
      <span class="pill" id="store-pill">Storage: Browser</span>
    </div>
  </header>

  <!-- SETTINGS -->
  <section class="card">
    <h2 style="margin-top:0">Settings</h2>
    <div class="row">
      <div class="col">
        <label>Mode</label>
        <select id="mode">
          <option value="local">Local (direct to OpenRouter)</option>
          <option value="backend">Backend (FastAPI/your API)</option>
        </select>
      </div>
      <div class="col" id="backend-url-col" style="display:none">
        <label>Backend URL (only for Backend mode)</label>
        <input id="backend-url" placeholder="https://your-api.onrender.com" />
      </div>
    </div>
    <div id="local-creds" class="row" style="margin-top:8px">
      <div class="col">
        <label>OpenRouter API Key (Local mode)</label>
        <input id="openrouter-key" placeholder="sk-..." />
      </div>
      <div class="col">
        <label>OpenRouter Model</label>
        <input id="openrouter-model" value="openrouter/auto" />
      </div>
    </div>
    <div class="stack" style="margin-top:8px">
      <button class="btn-accent" id="save-settings">Save Settings</button>
      <button class="btn-ghost" id="clear-local">Clear Local Data</button>
    </div>
    <p class="foot" style="margin-top:8px">
      <strong>Note:</strong> Local mode calls OpenRouter directly from the browser (fastest to start). Your key is stored in your browser’s localStorage.
      For production, switch to <em>Backend</em> mode later and keep keys server-side.
    </p>
  </section>

  <!-- MORNING -->
  <section class="card">
    <h2 style="margin-top:0">Morning Clarity</h2>
    <div class="row">
      <div class="col">
        <label>Primary Goal</label>
        <input id="m-goal" />
      </div>
      <div class="col">
        <label>Single Most Important Outcome</label>
        <input id="m-outcome" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Proactive Adjustment</label>
        <input id="m-adjust" />
      </div>
      <div class="col">
        <label>Success Definition</label>
        <input id="m-success" />
      </div>
    </div>
    <div class="stack" style="margin-top:8px">
      <button class="btn-accent" id="run-morning">Run Morning</button>
    </div>
    <div style="margin-top:12px">
      <label>Result</label>
      <pre id="m-result"></pre>
    </div>
  </section>

  <!-- EVENING -->
  <section class="card">
    <h2 style="margin-top:0">Evening Optimization</h2>
    <div class="row">
      <div class="col">
        <label>Success Metric</label>
        <input id="e-metric" />
      </div>
      <div class="col">
        <label>Achieved?</label>
        <select id="e-achieved">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Primary Obstacle</label>
        <input id="e-obstacle" />
      </div>
      <div class="col">
        <label>Adjustment for Tomorrow</label>
        <input id="e-adjust" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>One Win</label>
        <input id="e-win" />
      </div>
    </div>
    <div class="stack" style="margin-top:8px">
      <button class="btn-accent" id="run-evening">Run Evening</button>
    </div>
    <div style="margin-top:12px">
      <label>Result</label>
      <pre id="e-result"></pre>
    </div>
  </section>

  <!-- WEEKLY -->
  <section class="card">
    <h2 style="margin-top:0">Weekly Review</h2>
    <p class="muted">Synthesizes your last entries and suggests 1–2 high-impact adjustments.</p>
    <div class="stack">
      <button class="btn-accent" id="run-weekly">Run Weekly Review</button>
      <button class="btn-ghost" id="export-data">Export Data (JSON)</button>
      <label class="btn-ghost" style="display:inline-block;cursor:pointer">
        Import Data <input type="file" id="import-file" style="display:none" />
      </label>
    </div>
    <div style="margin-top:12px">
      <label>Summary</label>
      <pre id="w-result"></pre>
    </div>
  </section>

  <section class="card">
    <h3 style="margin-top:0">Privacy & Key Safety</h3>
    <p class="foot">
      • Local mode stores your API key in <em>this browser’s</em> localStorage and sends requests from the browser to OpenRouter.<br/>
      • For production, switch to Backend mode and keep keys on the server. You can keep using this same frontend without changes.
    </p>
  </section>

  <p class="foot">© ZenMind</p>
</div>

<script>
/** ---------------------------
 *  Minimal local persistence
 * --------------------------*/
const store = {
  get k(){ return JSON.parse(localStorage.getItem('zenmind')||'{}') },
  set k(v){ localStorage.setItem('zenmind', JSON.stringify(v)) },
  get(key, def){ return (this.k[key] ?? def) },
  set(key, val){ const o = this.k; o[key]=val; this.k=o; },
  pushEntry(entry){ const o=this.k; o.journal=o.journal||[]; o.journal.push(entry); this.k=o; },
  journal(){ return this.get('journal', []) }
};

/** ---------------------------
 *  UI elements
 * --------------------------*/
const $ = sel => document.querySelector(sel);
const modeSelect = $('#mode');
const backendUrlCol = $('#backend-url-col');
const localCreds = $('#local-creds');
const backendUrlInput = $('#backend-url');
const keyInput = $('#openrouter-key');
const modelInput = $('#openrouter-model');

const modePill = $('#mode-pill');
const storePill = $('#store-pill');

const mGoal = $('#m-goal');
const mOutcome = $('#m-outcome');
const mAdjust = $('#m-adjust');
const mSuccess = $('#m-success');
const mRes = $('#m-result');

const eMetric = $('#e-metric');
const eAchieved = $('#e-achieved');
const eObstacle = $('#e-obstacle');
const eAdjust = $('#e-adjust');
const eWin = $('#e-win');
const eRes = $('#e-result');

const wRes = $('#w-result');

/** ---------------------------
 *  Init from local settings
 * --------------------------*/
function initSettings(){
  modeSelect.value = store.get('mode','local');
  backendUrlInput.value = store.get('backendUrl','');
  keyInput.value = store.get('openrouterKey','');
  modelInput.value = store.get('openrouterModel','openrouter/auto');
  applyModeUI();
  refreshPills();
}
function applyModeUI(){
  const useLocal = (modeSelect.value === 'local');
  backendUrlCol.style.display = useLocal ? 'none' : 'block';
  localCreds.style.display = useLocal ? 'flex' : 'none';
}
function refreshPills(){
  modePill.textContent = 'Mode: ' + (store.get('mode','local')==='local' ? 'Local (OpenRouter)' : 'Backend');
  storePill.textContent = 'Storage: Browser';
}
initSettings();

modeSelect.addEventListener('change', applyModeUI);
$('#save-settings').addEventListener('click', ()=>{
  store.set('mode', modeSelect.value);
  store.set('backendUrl', backendUrlInput.value.trim());
  store.set('openrouterKey', keyInput.value.trim());
  store.set('openrouterModel', modelInput.value.trim()||'openrouter/auto');
  refreshPills();
  alert('Settings saved.');
});
$('#clear-local').addEventListener('click', ()=>{
  if(confirm('Clear all local ZenMind data?')){
    localStorage.removeItem('zenmind');
    initSettings();
    mRes.textContent = '';
    eRes.textContent = '';
    wRes.textContent = '';
    alert('Local data cleared.');
  }
});

/** ---------------------------
 *  LLM call helpers
 * --------------------------*/
async function callLocalLLM(system, user){
  // OpenRouter (client-side). Expects key & model from Settings.
  const key = store.get('openrouterKey','').trim();
  const model = store.get('openrouterModel','openrouter/auto').trim();
  if(!key){ throw new Error('Missing OpenRouter key in Settings.') }
  const headers = {
    'Content-Type':'application/json',
    'Authorization': 'Bearer ' + key,
    'HTTP-Referer': location.origin,
    'X-Title': 'ZenMind'
  };
  const body = {
    model,
    messages: [
      { role:'system', content: system },
      { role:'user', content: user }
    ],
    temperature: 0.5
  };
  const r = await fetch('https://openrouter.ai/api/v1/chat/completions', {
    method:'POST', headers, body: JSON.stringify(body)
  });
  if(!r.ok) throw new Error('OpenRouter error: ' + r.status);
  const js = await r.json();
  return js.choices?.[0]?.message?.content || JSON.stringify(js);
}

async function callBackend(path, payload){
  const base = store.get('backendUrl','').trim();
  if(!base) throw new Error('Missing Backend URL in Settings.');
  const r = await fetch(base + path, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if(!r.ok) throw new Error('Backend error: ' + r.status);
  return r.json();
}

/** ---------------------------
 *  Prompts used
 * --------------------------*/
const P23 = `As my AI thinking partner familiar with my Execution DNA and obstacles, please help me start my day with clarity. Ask me these four questions:
1) Based on my primary goal of "{{goal}}" and my Execution DNA profile, what is the single most important outcome I need to achieve today?
2) What potential obstacles (internal or external) might interfere with achieving this outcome today, considering my known patterns?
3) What specific strategy or environmental adjustment can I implement proactively right now to mitigate the most likely obstacle?
4) What will 'success' for today look like, defined in a clear, measurable way?
After I answer, reflect my responses back to me and offer one insight based on my Execution DNA.

User Answers:
- Outcome: {{outcome}}
- Adjustment: {{adjust}}
- Success: {{success}}
`;

const P24 = `As my AI thinking partner, please help me reflect on today and optimize for tomorrow. Analyze these:
- Success metric: {{metric}}
- Achieved: {{achieved}}
- Primary obstacle: {{obstacle}}
- Adjustment for tomorrow: {{adjust}}
- One win: {{win}}

Now reflect succinctly, identify one recurring pattern, and propose one specific improvement for tomorrow aligned with my Execution DNA.`;

const P25 = `Weekly Pattern Recognition:
Synthesize the entries below into:
1) 2–3 recurring obstacles or challenges
2) 2–3 consistent strengths or successful strategies
3) Any patterns in when/where I’m most effective
4) 1–2 environmental adjustments to test next week
5) A single weekly focus theme

Entries:
`;

/** ---------------------------
 *  Actions: Morning / Evening / Weekly
 * --------------------------*/
function stamp(){ return new Date().toISOString() }

$('#run-morning').addEventListener('click', async ()=>{
  const payload = {
    goal: mGoal.value.trim(),
    single_outcome: mOutcome.value.trim(),
    proactive_adjustment: mAdjust.value.trim(),
    success_definition: mSuccess.value.trim()
  };
  const mode = store.get('mode','local');

  try{
    let analysis;
    if(mode==='backend'){
      const resp = await callBackend('/ingest/morning', payload);
      analysis = resp.analysis || JSON.stringify(resp);
    } else {
      const sys = "You are the user's AI Mirror. Be concise, practical, and aligned with their Execution DNA.";
      const user = P23
        .replace('{{goal}}', payload.goal||'')
        .replace('{{outcome}}', payload.single_outcome||'')
        .replace('{{adjust}}', payload.proactive_adjustment||'')
        .replace('{{success}}', payload.success_definition||'');
      analysis = await callLocalLLM(sys, user);
    }
    mRes.textContent = analysis;
    store.pushEntry({ts: stamp(), type:'morning', input: payload, analysis});
  }catch(e){
    mRes.textContent = 'Error: ' + e.message;
  }
});

$('#run-evening').addEventListener('click', async ()=>{
  const payload = {
    success_metric: eMetric.value.trim(),
    achieved: (eAchieved.value==='yes'),
    primary_obstacle: eObstacle.value.trim(),
    adjustment_for_tomorrow: eAdjust.value.trim(),
    one_win: eWin.value.trim()
  };
  const mode = store.get('mode','local');

  try{
    let analysis;
    if(mode==='backend'){
      const resp = await callBackend('/ingest/evening', payload);
      analysis = resp.analysis || JSON.stringify(resp);
    } else {
      const sys = "You are the user's AI Mirror. Reflect the day, then suggest one specific improvement.";
      const user = P24
        .replace('{{metric}}', payload.success_metric||'')
        .replace('{{achieved}}', payload.achieved ? 'Yes' : 'No')
        .replace('{{obstacle}}', payload.primary_obstacle||'')
        .replace('{{adjust}}', payload.adjustment_for_tomorrow||'')
        .replace('{{win}}', payload.one_win||'');
      analysis = await callLocalLLM(sys, user);
    }
    eRes.textContent = analysis;
    store.pushEntry({ts: stamp(), type:'evening', input: payload, analysis});
  }catch(e){
    eRes.textContent = 'Error: ' + e.message;
  }
});

$('#run-weekly').addEventListener('click', async ()=>{
  const entries = store.journal();
  const last7 = entries.slice(-200) // simple slice
  const text = last7.map(e => `${e.ts} [${e.type}]\n${e.analysis || JSON.stringify(e.input)}`).join('\n\n');
  const mode = store.get('mode','local');

  try{
    let summary;
    if(mode==='backend'){
      // Backend has /weekly/review GET in scaffold; here we do local version for single-file app
      const sys = "You are an AI Mirror. Identify patterns, strengths, obstacles, and adjustments.";
      summary = await callLocalLLM(sys, P25 + text);
    } else {
      const sys = "You are an AI Mirror. Identify patterns, strengths, obstacles, and adjustments.";
      summary = await callLocalLLM(sys, P25 + text);
    }
    wRes.textContent = summary;
    store.pushEntry({ts: stamp(), type:'weekly', input:{}, analysis: summary});
  }catch(e){
    wRes.textContent = 'Error: ' + e.message;
  }
});

/** ---------------------------
 *  Export / Import
 * --------------------------*/
$('#export-data').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(store.k,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `zenmind_export_${Date.now()}.json`;
  a.click();
});
$('#import-file').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const text = await f.text();
  try{
    const obj = JSON.parse(text);
    localStorage.setItem('zenmind', JSON.stringify(obj));
    initSettings();
    alert('Import complete.');
  }catch(err){
    alert('Import failed: ' + err.message);
  }
});
</script>
</body>
</html>

